<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brutus.ai</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: transparent;
      color: #fff;
      overflow: hidden;
      user-select: none;
    }
    
    .app-container {
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #0a0a12 0%, #12121f 50%, #0d1a2d 100%);
      border-radius: 16px;
      border: 1px solid rgba(255, 80, 80, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Title Bar */
    .title-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      -webkit-app-region: drag;
    }
    
    .title-bar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #ff5050, #ff7850);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Space Mono', monospace;
      font-weight: 700;
      font-size: 14px;
    }
    
    .logo-text {
      font-family: 'Space Mono', monospace;
      font-size: 16px;
      font-weight: 700;
    }
    
    .logo-text span {
      color: #ff5050;
    }
    
    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }
    
    .window-btn {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .window-btn:hover {
      opacity: 0.8;
    }
    
    .btn-minimize {
      background: #ffbd2e;
    }
    
    .btn-close {
      background: #ff5f57;
    }
    
    /* Content */
    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }
    
    /* Views */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    /* Login View */
    .login-view {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .login-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .login-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      margin-bottom: 32px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: all 0.3s;
    }
    
    .form-input:focus {
      border-color: rgba(255, 80, 80, 0.5);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: lowercase;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #ff5050, #ff7850);
      color: #fff;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 80, 80, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      margin-top: 12px;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .error-message {
      color: #ff5050;
      font-size: 13px;
      text-align: center;
      padding: 10px;
      background: rgba(255, 80, 80, 0.1);
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    
    .error-message.visible {
      display: block;
    }
    
    /* Dashboard View */
    .dashboard-view {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #ff5050, #ff7850);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Space Mono', monospace;
      font-weight: 700;
      font-size: 20px;
    }
    
    .user-details h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .user-details p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .status-section {
      margin-bottom: 24px;
    }
    
    .status-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    
    .status-indicator {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 3px solid rgba(255, 255, 255, 0.1);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .status-indicator.active {
      background: rgba(80, 255, 128, 0.1);
      border-color: #50ff80;
      box-shadow: 0 0 30px rgba(80, 255, 128, 0.2);
    }
    
    .status-indicator-inner {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s;
    }
    
    .status-indicator.active .status-indicator-inner {
      background: #50ff80;
      box-shadow: 0 0 15px #50ff80;
    }
    
    .status-text {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 20px;
    }
    
    .monitor-btn {
      padding: 16px 32px;
      font-size: 16px;
    }
    
    .monitor-btn.active {
      background: linear-gradient(135deg, #ff5050, #cc3030);
    }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: auto;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
    }
    
    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: lowercase;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-family: 'Space Mono', monospace;
      font-size: 24px;
      font-weight: 700;
    }
    
    .stat-value.good { color: #50ff80; }
    .stat-value.warning { color: #ffb050; }
    .stat-value.bad { color: #ff5050; }
    
    /* Footer */
    .footer-actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
    }
    
    .footer-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: lowercase;
    }
    
    .footer-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Title Bar -->
    <div class="title-bar">
      <div class="title-bar-logo">
        <div class="logo-icon">B</div>
        <div class="logo-text">brutus<span>.ai</span></div>
      </div>
      <div class="window-controls">
        <button class="window-btn btn-minimize" id="btn-minimize"></button>
        <button class="window-btn btn-close" id="btn-close"></button>
      </div>
    </div>
    
    <!-- Content -->
    <div class="content">
      <!-- Login View -->
      <div class="view login-view active" id="login-view">
        <div class="login-title">welcome back</div>
        <div class="login-subtitle">sign in to start coaching</div>
        
        <div class="error-message" id="error-message"></div>
        
        <form id="login-form">
          <div class="form-group">
            <input type="email" class="form-input" placeholder="email" id="email" required>
          </div>
          <div class="form-group">
            <input type="password" class="form-input" placeholder="password" id="password" required>
          </div>
          <button type="submit" class="btn btn-primary" id="login-btn">login</button>
        </form>
        
        <button class="btn btn-secondary" id="signup-toggle">need an account? sign up</button>
      </div>
      
      <!-- Signup View -->
      <div class="view login-view" id="signup-view">
        <div class="login-title">create account</div>
        <div class="login-subtitle">get ready to improve your sales</div>
        
        <div class="error-message" id="signup-error-message"></div>
        
        <form id="signup-form">
          <div class="form-group">
            <input type="text" class="form-input" placeholder="name" id="signup-name" required>
          </div>
          <div class="form-group">
            <input type="email" class="form-input" placeholder="email" id="signup-email" required>
          </div>
          <div class="form-group">
            <input type="password" class="form-input" placeholder="password (min 8 characters)" id="signup-password" required minlength="8">
          </div>
          <button type="submit" class="btn btn-primary" id="signup-btn">create account</button>
        </form>
        
        <button class="btn btn-secondary" id="login-toggle">already have an account? login</button>
      </div>
      
      <!-- Dashboard View -->
      <div class="view dashboard-view" id="dashboard-view">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-details">
            <h3 id="user-name">User</h3>
            <p id="user-email">user@example.com</p>
          </div>
        </div>
        
        <div class="status-section">
          <div class="status-card">
            <div class="status-indicator" id="status-indicator">
              <div class="status-indicator-inner"></div>
            </div>
            <div class="status-text" id="status-text">not monitoring</div>
            <button class="btn btn-primary monitor-btn" id="monitor-btn">start monitoring</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">calls today</div>
            <div class="stat-value good" id="calls-today">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">talk ratio</div>
            <div class="stat-value warning" id="talk-ratio">--%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">avg score</div>
            <div class="stat-value" id="avg-score">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">total calls</div>
            <div class="stat-value good" id="total-calls">0</div>
          </div>
        </div>
        
        <div class="footer-actions">
          <button class="footer-btn" id="settings-btn">settings</button>
          <button class="footer-btn" id="logout-btn">logout</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== CONFIG ====================
    let API_URL = 'http://localhost:3001';
    let authToken = null;
    let currentUser = null;
    let isMonitoring = false;
    
    // ==================== INIT ====================
    async function init() {
      // Load settings
      const settings = await window.brutus.getSettings();
      API_URL = settings.apiUrl || API_URL;
      
      // Check existing auth
      const auth = await window.brutus.getAuth();
      if (auth.token && auth.user) {
        authToken = auth.token;
        currentUser = auth.user;
        
        // Verify token is still valid
        try {
          await apiCall('/auth/me');
          showDashboard();
        } catch (e) {
          await window.brutus.clearAuth();
          showLogin();
        }
      } else {
        showLogin();
      }
      
      // Check monitoring status
      isMonitoring = await window.brutus.isMonitoring();
      updateMonitoringUI();
    }
    
    // ==================== API ====================
    async function apiCall(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error?.message || 'Request failed');
      }
      
      return data;
    }
    
    // ==================== VIEWS ====================
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }
    
    function showLogin() {
      showView('login-view');
    }
    
    function showSignup() {
      showView('signup-view');
    }
    
    function showDashboard() {
      showView('dashboard-view');
      
      // Update user info
      if (currentUser) {
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-email').textContent = currentUser.email;
      }
      
      // Load stats
      loadDashboardStats();
    }
    
    async function loadDashboardStats() {
      try {
        const data = await apiCall('/user/dashboard');
        
        if (data.profile) {
          document.getElementById('total-calls').textContent = data.profile.totalCallsAnalyzed || 0;
          
          const talkRatio = data.profile.talkRatioAvg;
          const talkRatioEl = document.getElementById('talk-ratio');
          talkRatioEl.textContent = talkRatio ? `${Math.round(talkRatio)}%` : '--%';
          talkRatioEl.className = 'stat-value ' + (talkRatio > 50 ? 'bad' : talkRatio > 40 ? 'warning' : 'good');
        }
        
        if (data.weeklyStats) {
          document.getElementById('calls-today').textContent = data.weeklyStats.callCount || 0;
          
          const scores = data.weeklyStats.scores || [];
          if (scores.length > 0) {
            const avgScore = Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length);
            const avgScoreEl = document.getElementById('avg-score');
            avgScoreEl.textContent = avgScore;
            avgScoreEl.className = 'stat-value ' + (avgScore >= 70 ? 'good' : avgScore >= 50 ? 'warning' : 'bad');
          }
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }
    
    // ==================== AUTH ====================
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const btn = document.getElementById('login-btn');
      const errorEl = document.getElementById('error-message');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      errorEl.classList.remove('visible');
      
      try {
        const data = await apiCall('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });
        
        authToken = data.token;
        currentUser = data.user;
        
        await window.brutus.setAuth({ token: authToken, user: currentUser });
        
        showDashboard();
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('visible');
      } finally {
        btn.disabled = false;
        btn.textContent = 'login';
      }
    });
    
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const btn = document.getElementById('signup-btn');
      const errorEl = document.getElementById('signup-error-message');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      errorEl.classList.remove('visible');
      
      try {
        const data = await apiCall('/auth/signup', {
          method: 'POST',
          body: JSON.stringify({ name, email, password })
        });
        
        authToken = data.token;
        currentUser = data.user;
        
        await window.brutus.setAuth({ token: authToken, user: currentUser });
        
        showDashboard();
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('visible');
      } finally {
        btn.disabled = false;
        btn.textContent = 'create account';
      }
    });
    
    document.getElementById('signup-toggle').addEventListener('click', showSignup);
    document.getElementById('login-toggle').addEventListener('click', showLogin);
    
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await window.brutus.clearAuth();
      authToken = null;
      currentUser = null;
      showLogin();
    });
    
    // ==================== MONITORING ====================
    document.getElementById('monitor-btn').addEventListener('click', async () => {
      if (isMonitoring) {
        await window.brutus.stopMonitoring();
        isMonitoring = false;
      } else {
        await window.brutus.startMonitoring();
        isMonitoring = true;
      }
      updateMonitoringUI();
    });
    
    function updateMonitoringUI() {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const btn = document.getElementById('monitor-btn');
      
      if (isMonitoring) {
        indicator.classList.add('active');
        statusText.textContent = 'monitoring active';
        btn.textContent = 'stop monitoring';
        btn.classList.add('active');
      } else {
        indicator.classList.remove('active');
        statusText.textContent = 'not monitoring';
        btn.textContent = 'start monitoring';
        btn.classList.remove('active');
      }
    }
    
    // ==================== WINDOW CONTROLS ====================
    document.getElementById('btn-minimize').addEventListener('click', () => {
      window.brutus.minimize();
    });
    
    document.getElementById('btn-close').addEventListener('click', () => {
      window.brutus.close();
    });
    
    // ==================== START ====================
    init();
  </script>
</body>
</html>
